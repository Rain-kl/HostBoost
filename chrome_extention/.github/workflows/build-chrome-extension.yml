name: Build Chrome Extension

on:
    workflow_dispatch:
        inputs:
            create_release:
                description: "创建 GitHub Release"
                required: false
                default: false
                type: boolean

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Generate Build Version
              id: version
              run: |
                  VERSION=$(date -u +"%Y.%m.%d.%H%M%S")
                  echo "build_version=${VERSION}" >> $GITHUB_OUTPUT
                  echo "tag=chrome-ext-v${VERSION}" >> $GITHUB_OUTPUT
                  echo "BUILD_VERSION=${VERSION}" >> $GITHUB_ENV
                  echo "Generated build version: ${VERSION}"

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "pnpm"
                  cache-dependency-path: chrome_extention/pnpm-lock.yaml

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 9

            - name: Install dependencies
              working-directory: chrome_extention
              run: pnpm install --frozen-lockfile

            - name: Update manifest version
              working-directory: chrome_extention
              run: |
                  VERSION="${{ steps.version.outputs.build_version }}"
                  sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"${VERSION}\"/" public/manifest.json
                  echo "Updated manifest.json version to ${VERSION}"

            - name: Build Chrome Extension
              working-directory: chrome_extention
              run: pnpm build

            - name: Smoke test preview server
              working-directory: chrome_extention
              run: |
                  pnpm preview -- --host 127.0.0.1 --port 4173 --strictPort &
                  PREVIEW_PID=$!
                  echo "Preview started with PID ${PREVIEW_PID}"
                  sleep 5
                  kill ${PREVIEW_PID}
                  echo "Preview process stopped successfully."

            - name: Package Chrome Extension
              working-directory: chrome_extention
              run: |
                  cd dist
                  zip -r ../chrome-extension-${{ steps.version.outputs.build_version }}.zip .
                  cd ..

            - name: Upload Chrome Extension Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: chrome-extension-${{ steps.version.outputs.build_version }}
                  path: chrome_extention/chrome-extension-${{ steps.version.outputs.build_version }}.zip
                  retention-days: 30

            - name: Create Release
              if: ${{ inputs.create_release }}
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ steps.version.outputs.tag }}
                  name: Chrome Extension ${{ steps.version.outputs.build_version }}
                  files: chrome_extention/chrome-extension-${{ steps.version.outputs.build_version }}.zip
                  draft: false
                  prerelease: false
                  generate_release_notes: true
                  body: |
                      ## Chrome Extension Build

                      **Version:** ${{ steps.version.outputs.build_version }}
                      **Build Date (UTC):** ${{ steps.version.outputs.build_version }}

                      ### 下载说明
                      1. 日期版本构建的属于测试版, 除非你知道自己在做什么, 否则建议使用 V 开头的正式版。
                      2. 下载 `chrome-extension-${{ steps.version.outputs.build_version }}.zip`
                      3. 在 Chrome 浏览器中打开 `chrome://extensions/`
                      4. 启用"开发者模式"
                      5. 点击"加载已解压的扩展程序"并选择解压后的文件夹
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Summary
              run: |
                  echo "## Build Summary :rocket:" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Project:** Chrome Extension" >> $GITHUB_STEP_SUMMARY
                  echo "**Version:** ${{ steps.version.outputs.build_version }}" >> $GITHUB_STEP_SUMMARY
                  echo "**Status:** ✅ Success" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Build Version" >> $GITHUB_STEP_SUMMARY
                  echo "- $BUILD_VERSION" >> $GITHUB_STEP_SUMMARY
                  echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
                  echo "- chrome-extension-${{ steps.version.outputs.build_version }}.zip" >> $GITHUB_STEP_SUMMARY
